<script src="codemirror/lib/codemirror.js"></script>
<script src="json.js"></script>
<script src="mips.js"></script>
<script src="asm.js"></script>
<script src="disasm.js"></script>
<script src="vm.js"></script>
<script src="mips_codemirror.js"></script>
<link rel="stylesheet" href="codemirror/lib/codemirror.css">
<link rel="stylesheet" href="vm.css">
<link rel="stylesheet" href="evalc.css">
<body>
<div id="container">
  <div id="sub-left">
  </div>
  <div id="sub-right">
  <!--
  <table class="legend">
  <tr><th>Legend</th><th></th><th></th></tr>
  <tr><td></td><td id="code">&nbsp;&nbsp;</td><td>Code</td></tr>
  <tr><td></td><td id="stack">&nbsp;&nbsp;</td><td>Stack</td></tr>
  <tr><td></td><td id="heap">&nbsp;&nbsp;</td><td>Heap</td></tr>
  <tr><td></td><td id="unalloc">&nbsp;&nbsp;</td><td>Unallocated</td></tr>
  </table>
  --!>
  <button id="assemble" onclick="do_assemble()">Assemble</button>
  <button id="step" onclick="do_step()" style="visibility: hidden;">Step</button>
  <button id="run" onclick="do_run()" style="visibility: hidden;">Run</button>
  <button id="faster" onclick="do_faster()" style="visibility: hidden;">Faster!</button>
  <button id="stop" onclick="do_stop()" style="visibility: hidden;">Stop</button>
  <button id="reset" onclick="do_reset()" style="visibility: hidden;">Reset</button>
  <p id="error"></p>
  <div style="overflow-y:scroll;">
  <table id="RAM" class="RAM">
  </table>
  <table id="regs" class="regs">
  </table>
  </div>
  <input type="text" style="width:100%; border: 1px solid black;"/>
  </div>
</div>
</body>

<script type="text/javascript">
var editor = CodeMirror(document.getElementById('sub-left'), {
                        mode: "mips",
                        value: "; Puts Fibonacci numbers into RAM\naddi $1, $0, 0     ; f_{n-1}\naddi $2, $0, 1     ; f_n\naddi $5, $0, 0x15  ; end condition\nloop: sw $2, end($3)\naddi $3, $3, 1     ; advance pointer\nadd $4, $2, $0     ; tmp = f_n\nadd $2, $2, $1     ; f_{n+1} = fn + f_{n-1}\nadd $1, $4, $0     ; f_{n-1} = tmp\nbeq $3, $5, done   ; don't overflow memory\nj loop\ndone: beq $0, $0, -1     ; infinite loop\nend:",
                        //add $1, $0, $0\naddi $2, $0, 6\nloop: addi $1, $1, 1\nsw $1, 32($0)\nbeq $1, $2, exit\nj loop\nexit: jr $31" ,

                        lineNumbers: true,
                        firstLineNumber: 0,
                        indentUnit: 0,
                        onChange: peek,
                        autoClearEmptyLines: true,
                       });
var labelre = new RegExp(/^[a-z][a-zA-Z0-9]*:/);
var maxlabelsize = 0;
function max(a, b) { return a>b?a:b; }
function toHex(d, padding) {
  var hex = Number(d).toString(16);
  padding = typeof (padding) === "undefined" || padding === null ? padding = 2 : padding;
  while (hex.length < padding) {
    hex = "0" + hex;
  }
  return "0x" + hex;
}

function peek() {
  editor.setOption('onChange', null);
  var lineNum = editor.getCursor().line;
  var line = editor.getLine(lineNum);
  if(match = labelre.exec(line)) {
    maxlabelsize = max(maxlabelsize, match[0].length + 1);
  }
  editor.indentLine(lineNum);
  editor.setOption('indentUnit', maxlabelsize);
  editor.setOption('onChange', peek);
}

for(var j = 0; j < 2; j++) {
for(var i = 0; i < editor.lineCount(); i++) {
  editor.setCursor(i,0);
  peek();
}
}
vm = make_vm(32);
make_RAM_table(vm, document.getElementById('RAM'));
make_reg_table(vm, document.getElementById('regs'));

function do_step() {
  try { step(vm); }
  catch (err) {
    document.getElementById('error').innerHTML = err.message;
  }
}

function do_assemble() {
  var asm = asmtomips(editor.getValue());
  for(var idx=0;idx<asm.length;idx++) {
    program_ram(vm, idx, asm[idx]);
    update_ram(vm, idx);
  }
  document.getElementById('assemble').style.visibility = 'hidden';
  document.getElementById('step').style.visibility = 'visible';
  document.getElementById('run').style.visibility = 'visible';
  document.getElementById('reset').style.visibility = 'visible';
  document.getElementById('faster').style.visibility = 'hidden';
  document.getElementById('stop').style.visibility = 'hidden';
}

function do_reset() {
  vm = make_vm(32);
  make_RAM_table(vm, document.getElementById('RAM'));
  make_reg_table(vm, document.getElementById('regs'));
  document.getElementById('assemble').style.visibility = 'visible';
  document.getElementById('step').style.visibility = 'hidden';
  document.getElementById('run').style.visibility = 'hidden';
  document.getElementById('reset').style.visibility = 'hidden';
  document.getElementById('faster').style.visibility = 'hidden';
  document.getElementById('stop').style.visibility = 'hidden';
}

var run_handle;
var run_length;

function do_run() {
  run_handle = setInterval(do_step, 800);
  run_length = 800;
  document.getElementById('assemble').style.visibility = 'hidden';
  document.getElementById('step').style.visibility = 'hidden';
  document.getElementById('run').style.visibility = 'hidden';
  document.getElementById('reset').style.visibility = 'hidden';
  document.getElementById('faster').style.visibility = 'visible';
  document.getElementById('stop').style.visibility = 'visible';
}

function do_faster() {
  run_length /= 2;
  clearInterval(run_handle);
  run_handle = setInterval(do_step, run_length);
  if(run_length <= 10) document.getElementById('faster').style.visibility = 'hidden';
}

function do_stop() {
  clearInterval(run_handle);
  document.getElementById('assemble').style.visibility = 'hidden';
  document.getElementById('step').style.visibility = 'visible';
  document.getElementById('run').style.visibility = 'visible';
  document.getElementById('reset').style.visibility = 'visible';
  document.getElementById('faster').style.visibility = 'hidden';
  document.getElementById('stop').style.visibility = 'hidden';
}
      
</script>
<pre id="asm">
</pre>
